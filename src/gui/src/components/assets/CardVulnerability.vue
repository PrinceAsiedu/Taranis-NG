<template>
    <div class="card-item" data-type="vulnerability-item">
        <v-hover v-slot:default="{hover}" close-delay="150">
            <v-card flat class="card mb-1" :elevation="hover ? 12 : 2"
                    @click.stop="cardItemToolbar"
                    @mouseenter.native="toolbar=true"
                    @mouseleave.native="toolbar=false"
            >
                <v-layout row wrap class="pa-1 pl-0 status" v-bind:class="itemStatus">
                    <v-row justify="center">
                        <v-flex>
                            <v-row>

                                <!-- Icon -->
                                <v-col class="cs-card-col-0">
                                    <div>
                                        <v-icon center class="pa-1 pt-2">{{itemStatusIcon}}</v-icon>
                                    </div>
                                </v-col>

                                <!--Title-->
                                <v-col class="cs-card-col-1">
                                    <div class="caption grey--text">{{$t('card_item.title')}}</div>
                                    <span>{{card.report_item.title}}</span>
                                </v-col>

                                <!--Date/Time-->
                                <v-col class="cs-card-col-2">
                                    <div class="caption grey--text">{{$t('card_item.created')}}</div>
                                    <span>{{card.report_item.created}}</span>
                                </v-col>

                                <!-- Toolbar -->
                                <v-col class="cs-card-col-3">
                                    <v-speed-dial v-if="editAllowed()" class="newdialshort"
                                                  v-model="toolbar"
                                                  direction="left"
                                                  transition='slide-x-reverse-transition'
                                                  bottom>
                                        <v-item-group>
                                            <v-btn icon @click.stop="cardItemToolbar('solve')">
                                                <v-icon color="accent">{{actionIcon}}</v-icon>
                                            </v-btn>
                                        </v-item-group>

                                    </v-speed-dial>
                                </v-col>

                            </v-row>
                        </v-flex>
                    </v-row>
                </v-layout>
            </v-card>
        </v-hover>
    </div>
</template>

<script>
    import {solveVulnerability} from "@/api/assets";
    import AuthMixin from "@/services/auth/auth_mixin";
    import Permissions from "@/services/auth/permissions";

    export default {
        name: "CardVulnerability",
        mixins: [AuthMixin],
        props: {
            card: Object,
            asset: Object,
        },
        data: () => ({
            toolbar: false,
        }),
        computed:{
            itemStatus: function () {
                if (this.card.solved) {
                    return "completed"
                } else {
                    return "alert"
                }
            },
            itemStatusIcon: function () {
                if (this.card.solved) {
                    return "mdi-check-circle-outline"
                } else {
                    return "mdi-alert-outline"
                }
            },
            actionIcon: function () {
                if (this.card.solved) {
                    return "mdi-alert-circle-outline"
                } else {
                    return "mdi-checkbox-marked-circle-outline"
                }
            }
        },
        methods: {
            editAllowed() {
                return this.checkPermission(Permissions.MY_ASSETS_CREATE)
            },
            itemClicked(data) {
                this.$root.$emit('show-vulnerability-detail', data.report_item);
            },
            solveClicked() {
                solveVulnerability({
                    asset_id: this.asset.id,
                    report_item_id: this.card.report_item.id,
                    solved: !this.card.solved
                }).then(() => {
                    this.card.solved = !this.card.solved

                })
            },
            cardItemToolbar(action) {
                switch (action) {
                    case "solve":
                        this.solveClicked();
                        break;

                    default:
                        this.toolbar = false;
                        this.itemClicked(this.card);
                        break;
                }
            }
        }
    }
</script>

<style>

    .card .cs-card-col-0 {
        max-width: 5%;
    }

    .card .cs-card-col-1 {
        max-width: 60%;
    }

    .card .cs-card-col-2 {
        max-width: 30%;
    }

    .card .cs-card-col-3 {
        max-width: 5%;
    }

    .card .obj.center {
        text-align: center;
    }

    .card.elevation-12 {
        z-index: 1;
        background-color: rgba(100, 137, 214, 0.1);
    }

    .card .status.in_progress {
        border-left: 4px solid #ffd556;
    }

    .card .status.completed {
        border-left: 4px solid #33DD40;
    }

    .card .status.alert {
        border-left: 4px solid red;
    }
</style>